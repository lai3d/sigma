services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: sigma
      POSTGRES_PASSWORD: sigma
      POSTGRES_DB: sigma
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sigma"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: unless-stopped

  api:
    build: ./sigma-api
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgres://sigma:sigma@db:5432/sigma
      REDIS_URL: redis://redis:6379
      LISTEN_HOST: 0.0.0.0
      LISTEN_PORT: 3000
      API_KEY: ${API_KEY:-change-me-in-production}
      JWT_SECRET: ${JWT_SECRET:-sigma-dev-secret}
      RUST_LOG: ${RUST_LOG:-info}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
      WEBHOOK_URL: ${WEBHOOK_URL:-}
      NOTIFY_BEFORE_DAYS: ${NOTIFY_BEFORE_DAYS:-7,3,1}
      NOTIFY_INTERVAL_SECS: ${NOTIFY_INTERVAL_SECS:-3600}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped

  web:
    build: ./sigma-web
    ports:
      - "80:80"
    environment:
      API_URL: http://api:3000
    depends_on:
      - api
    restart: unless-stopped

  probe:
    build: ./sigma-probe
    cap_add:
      - NET_RAW
    environment:
      SIGMA_API_URL: http://api:3000/api
      SIGMA_API_KEY: ${API_KEY:-change-me-in-production}
      PROBE_SOURCE: cn-beijing
      PROBE_INTERVAL: 300
      PROBE_TYPES: icmp,tcp,http
    depends_on:
      - api
    restart: unless-stopped

  agent:
    build: ./sigma-agent
    network_mode: host
    # Port scanning requires host network to see real port usage.
    # The allocate-ports proxy from API won't work in local Docker Desktop
    # (API can't reach host network). Works in production where agent runs
    # directly on VPS and API connects via public IP.
    environment:
      SIGMA_API_URL: http://localhost:3000/api
      SIGMA_API_KEY: ${API_KEY:-change-me-in-production}
      AGENT_INTERVAL: 60
      AGENT_ALIAS: hk004.example.com
      AGENT_METRICS_PORT: 9102
      AGENT_PORT_SCAN: "true"
      AGENT_PORT_SCAN_RANGE: 10000-30000
      AGENT_PORT_SCAN_INTERVAL: 60
      AGENT_XDS_ENABLED: ${AGENT_XDS_ENABLED:-false}
      AGENT_XDS_PORT: ${AGENT_XDS_PORT:-18000}
      AGENT_XDS_POLL_INTERVAL: ${AGENT_XDS_POLL_INTERVAL:-10}
      AGENT_ENVOY_CONFIG_PATH: ${AGENT_ENVOY_CONFIG_PATH:-/etc/envoy/envoy.yaml}
      AGENT_ENVOY_CONFIG_SYNC: ${AGENT_ENVOY_CONFIG_SYNC:-false}
      AGENT_ENVOY_CONFIG_SYNC_INTERVAL: ${AGENT_ENVOY_CONFIG_SYNC_INTERVAL:-60}
    # volumes:
    #   - /etc/hostname:/etc/host_hostname:ro
    #   - /etc/envoy/envoy.yaml:/etc/envoy/envoy.yaml:ro  # Mount for static config sync
    depends_on:
      - api
    restart: unless-stopped

  test-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: sigma_test
      POSTGRES_PASSWORD: sigma_test
      POSTGRES_DB: sigma_test
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sigma_test"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  pgdata:
